#!/usr/bin/env bash
set -e

# transparent-sops
# Usage: ./transparent-sops init

# Check dependencies
if ! command -v sops >/dev/null 2>&1; then
    echo "Error: 'sops' is not installed or not in PATH."
    exit 1
fi

list_encrypted_files() {
    # Find files with the sops-crypt filter
    # Use --stdin for performance on larger repos
    git ls-files | git check-attr --stdin filter | while IFS= read -r line; do
        FILE="${line%: filter: sops-crypt}"
        if [ "$FILE" != "$line" ]; then
            echo "$FILE"
        fi
    done
}

COMMAND="$1"

if [ "$COMMAND" = "init" ]; then
    # Resolve absolute path to the filters directory where THIS script is located
    SOURCE="${BASH_SOURCE[0]}"
    while [ -h "$SOURCE" ]; do
        DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
        SOURCE="$(readlink "$SOURCE")"
        [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
    done
    SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
    SCRIPT_PATH="$SCRIPT_DIR/$(basename "$SOURCE")"

    # Determine command to use in git config
    # If transparent-sops is in PATH and points to this script, we can use just the name
    if command -v transparent-sops >/dev/null 2>&1 && [ "$(command -v transparent-sops)" = "$SCRIPT_PATH" ]; then
        CMD="transparent-sops"
    else
        CMD="$SCRIPT_PATH"
    fi

    # Safety check: ensure working tree is clean
    if [ -n "$(git status --porcelain)" ]; then
        echo "Error: Working tree is not clean. Please commit or stash your changes before initializing."
        exit 1
    fi

    echo "Initializing transparent-sops for this repository..."

    # Check if filters were already configured
    WAS_CONFIGURED=$(git config --get filter.sops-crypt.smudge || true)

    FILES_TO_RESMUDGE=()
    if [ -z "$WAS_CONFIGURED" ]; then
        # Find files with the sops-crypt filter that are currently clean
        while IFS= read -r FILE; do
            # Check if file is clean and exists
            if [ -f "$FILE" ] && [ -z "$(git status --porcelain -- "$FILE")" ]; then
                FILES_TO_RESMUDGE+=("$FILE")
            fi
        done < <(list_encrypted_files)
    fi

    # Configure git
    git config filter.sops-crypt.clean "$CMD filter clean"
    git config filter.sops-crypt.smudge "$CMD filter smudge"
    git config filter.sops-crypt.required true
    git config diff.sops-crypt.textconv "$CMD filter diff"

    echo "Configuration applied."

    if [ ${#FILES_TO_RESMUDGE[@]} -gt 0 ]; then
        echo "Detected first-time initialization in a repo with filtered files."
        echo "Decrypting clean files..."
        for FILE in "${FILES_TO_RESMUDGE[@]}"; do
            echo "  $FILE"
            # Force checkout to trigger smudge filter
            git checkout HEAD -- "$FILE" >/dev/null 2>&1
        done
        echo "Decryption complete."
    fi

    echo "Add the following to your .gitattributes to use it (if not already present):"
    echo "* filter=sops-crypt diff=sops-crypt"

elif [ "$COMMAND" = "filter" ]; then
    SUBCOMMAND="$2"
    case "$SUBCOMMAND" in
        clean)
            sops --encrypt --input-type binary --output-type binary /dev/stdin
            ;;
        smudge)
            sops --decrypt --input-type binary --output-type binary /dev/stdin
            ;;
        diff)
            FILE_PATH="$3"
            if [ -z "$FILE_PATH" ]; then
                echo "Usage: $0 filter diff <file>" >&2
                exit 1
            fi
            if sops --decrypt --input-type binary --output-type binary "$FILE_PATH" 2>/dev/null; then
                : # Success
            else
                cat "$FILE_PATH"
            fi
            ;;
        *)
            echo "Usage: $0 filter {clean|smudge|diff}"
            exit 1
            ;;
    esac

elif [ "$COMMAND" = "uninstall" ]; then
    echo "Uninstalling transparent-sops from this repository..."
    
    # Remove git config sections
    git config --remove-section filter.sops-crypt 2>/dev/null || true
    git config --remove-section diff.sops-crypt 2>/dev/null || true

    echo "Configuration removed."
    echo "Remember to remove sops-crypt attributes from your .gitattributes file."

elif [ "$COMMAND" = "ls-crypt" ]; then
    list_encrypted_files

else
    echo "Usage: $0 {init|uninstall|ls-crypt|filter}"
    exit 1
fi
